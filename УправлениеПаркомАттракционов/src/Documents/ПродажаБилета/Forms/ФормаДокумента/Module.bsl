
#Область ОписаниеПеременных

#КонецОбласти

#Область ОбработчикиСобытийФормы

// Код процедур и функций

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура НоменклатураПриИзменении(Элемент)
	
	Объект.Цена = ЦенаНоменклатуры(Объект.Номенклатура, Объект.Дата);
	
	РассчитатьСуммуДокумента();
	
	
КонецПроцедуры

&НаКлиенте
Процедура ЦенаПриИзменении(Элемент)
	РассчитатьСуммуДокумента();
КонецПроцедуры


&НаКлиенте
Процедура СкидкаПриИзменении(Элемент)
	РассчитатьСуммуДокумента();
КонецПроцедуры


&НаКлиенте
Процедура СуммаДокументаПриИзменении(Элемент)
	Объект.БаллыКСписанию = Объект.Цена - Объект.СуммаДокумента;
КонецПроцедуры
#КонецОбласти

#Область ОбработчикиКомандФормы

// Код процедур и функций

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура РассчитатьСуммуДокумента()

	Объект.СуммаДокумента = Объект.Цена - Объект.БаллыКСписанию;

КонецПроцедуры	

&НаСервереБезКонтекста
Функция ЦенаНоменклатуры(Знач Номенклатура, Знач Период)

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЦеныНоменклатурыСрезПоследних.Цена
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&Период, Номенклатура = &Номенклатура) КАК
		|		ЦеныНоменклатурыСрезПоследних";
		
	Запрос.УстановитьПараметр("Период", Период);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Цена;
	КонецЕсли;
	
	Возврат 0;
	
КонецФункции

//&НаСервереБезКонтекста
//Функция ЦенаНоменклатуры(Знач Номенклатура, Знач Период)
//    Если Номенклатура = Неопределено Тогда
//        Возврат 0;
//    КонецЕсли;
//    
//    Запрос = Новый Запрос;
//    Запрос.Текст = 
//    "ВЫБРАТЬ
//    | ЦеныНоменклатурыСрезПоследних.Цена
//    |ИЗ
//    | РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&Период, Номенклатура = &Номенклатура) КАК
//    |  ЦеныНоменклатурыСрезПоследних";
//    
//    Запрос.УстановитьПараметр("Период", Период);
//    Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
//    
//    Попытка
//        Результат = Запрос.Выполнить();
//        Выборка = Результат.Выбрать();
//        
//        Если Выборка.Следующий() Тогда
//            Возврат Выборка.Цена;
//        Иначе
//            // Добавьте отладку здесь
//            Сообщить("Не найдена цена для номенклатуры " + Номенклатура.Наименование + " на дату " + Период);
//            Возврат 0;
//        КонецЕсли;
//    Исключение
//        // Добавьте отладку ошибок
//        Сообщить("Ошибка при выполнении запроса: " + ОписаниеОшибки());
//        Возврат 0;
//    КонецПопытки;
//КонецФункции

#КонецОбласти
